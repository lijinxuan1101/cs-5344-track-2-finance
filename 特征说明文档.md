# 特征工程说明文档

## 概述

本文档详细说明特征工程脚本 (`feature_generator.py`) 生成的所有特征。特征工程采用模块化构建器设计，包括：
1. 静态特征构建器（StaticFeatureBuilder）
2. 偿债压力特征构建器（DebtServicingFeatureBuilder）
3. 杠杆风险特征构建器（LeverageFeatureBuilder）
4. 摊销信号特征构建器（AmortizationFeatureBuilder）
5. 余额特征构建器（BalanceFeatureBuilder）
6. 到期风险特征构建器（MaturityRiskFeatureBuilder）
7. 通用时序特征构建器（GenericTemporalBuilder）

**最终特征数量**：69个特征（删除后约55个特征）

**特征处理流程**：
1. Sentinel值处理（将特殊值转为NaN）
2. 分类变量编码（LabelEncoder）
3. 数值变量填充（中位数）
4. 特征构建（各构建器生成特征）
5. 特征删除（移除低价值特征）
6. 标准化（RobustScaler）

---

## 一、静态特征 (Static Features)

### 1.1 原始静态列（索引 0-30）

| 索引 | 特征名称 | 类型 | 说明 | AUPRC | AUROC | 重要性 |
|------|---------|------|------|-------|-------|--------|
| 0 | **CreditScore** | 数值 | 借款人信用分数 (300-850)，Sentinel值9999已处理 | 0.2106 | 0.6446 | ⭐⭐⭐⭐ |
| 1 | **FirstPaymentDate** | 日期 | 首次还款日期 (YYYYMM格式) | 0.1261 | 0.5002 | ⭐ |
| 2 | **FirstTimeHomebuyerFlag** | 分类 | 首次购房者标志 (Y/N/9)，已编码 | 0.1209 | 0.4733 | ⭐ |
| 3 | **MaturityDate** | 日期 | 贷款到期日期 (YYYYMM格式) | 0.1246 | 0.4900 | ⭐ |
| 4 | **MSA** | 分类 | 大都市统计区代码 | 0.1233 | 0.4896 | ⭐ |
| 5 | **MI_Pct** | 数值 | 抵押保险百分比 (0-55%，999=不可用)，已处理 | 0.1286 | 0.5123 | ⭐ |
| 6 | **NumberOfUnits** | 数值 | 住宅单元数 (1-4) | 0.1277 | 0.5054 | ⭐ |
| 7 | **OccupancyStatus** | 分类 | 占用状态 (P/I/S/9)，已编码 | 0.1266 | 0.5033 | ⭐ |
| 8 | **OriginalCLTV** | 数值 | 原始合并贷款价值比 | 0.1264 | 0.5046 | ⭐ |
| 9 | **OriginalDTI** | 数值 | 原始债务收入比 (%)，Sentinel值999已处理 | 0.1244 | 0.4941 | ⭐ |
| 10 | **OriginalUPB** | 数值 | 原始未偿本金余额 | 0.1272 | 0.5074 | ⭐ |
| 11 | **OriginalLTV** | 数值 | 原始贷款价值比，Sentinel值999已处理 | 0.1261 | 0.5086 | ⭐ |
| 12 | **OriginalInterestRate** | 数值 | 原始利率 | 0.1433 | 0.5453 | ⭐⭐⭐ |
| 13 | **Channel** | 分类 | 贷款渠道 (R/B/C/T/9)，已编码 | 0.1313 | 0.5173 | ⭐⭐ |
| 14 | **PPM_Flag** | 分类 | 提前还款罚金标志 (Y/N)，已编码 | 0.1261 | 0.5000 | ⭐ |
| 15 | **ProductType** | 分类 | 产品类型 (FRM/ARM)，已编码 | 0.1261 | 0.5000 | ⭐ |
| 16 | **PropertyState** | 分类 | 房产所在州（两字母代码），已编码 | 0.1261 | 0.4902 | ⭐ |
| 17 | **PropertyType** | 分类 | 房产类型 (SF/CO/PU/MH/CP/99)，已编码 | 0.1224 | 0.4705 | ⭐ |
| 18 | **PostalCode** | 分类 | 邮政编码，已编码 | 0.1208 | 0.4766 | ⭐ |
| 19 | **LoanPurpose** | 分类 | 贷款用途，已编码 | 0.1329 | 0.5280 | ⭐⭐ |
| 20 | **OriginalLoanTerm** | 数值 | 原始贷款期限（月） | 0.1248 | 0.4898 | ⭐ |
| 21 | **NumberOfBorrowers** | 数值 | 借款人数量 | 0.1403 | 0.5559 | ⭐⭐⭐ |
| 22 | **SellerName** | 分类 | 卖方名称，已编码 | 0.1223 | 0.4810 | ⭐ |
| 23 | **ServicerName** | 分类 | 服务商名称，已编码 | 0.1246 | 0.4981 | ⭐ |
| 24 | **SuperConformingFlag** | 分类 | 超级合格标志，已编码 | 0.1259 | 0.4962 | ⭐ |
| 25 | **PreHARP_Flag** | 分类 | Pre-HARP标志，已编码 | 0.1261 | 0.5000 | ⭐ |
| 26 | **ProgramIndicator** | 分类 | 项目指示器，已编码 | 0.1289 | 0.5114 | ⭐ |
| 27 | **ReliefRefinanceIndicator** | 分类 | 救济再融资指示器，已编码 | 0.1261 | 0.5000 | ⭐ |
| 28 | **PropertyValMethod** | 分类 | 房产估值方法，已编码 | 0.1263 | 0.4847 | ⭐ |
| 29 | **InterestOnlyFlag** | 分类 | 仅付利息标志 (Y/N)，已编码 | 0.1261 | 0.5000 | ⭐ |
| 30 | **BalloonIndicator** | 分类 | 气球贷款标志 (Y/N)，已编码 | 0.1290 | 0.5124 | ⭐ |

### 1.2 静态交互特征和信用行为特征（索引 31-35）

| 索引 | 特征名称 | 类型 | 计算公式 | AUPRC | AUROC | 重要性 |
|------|---------|------|----------|-------|-------|--------|
| 31 | **LTV_x_DTI** | 数值 | OriginalLTV × OriginalDTI | 0.1368 | 0.5238 | ⭐⭐⭐ |
| 32 | **UPB_per_CreditScore** | 数值 | OriginalUPB / (CreditScore + 1) | 0.1296 | 0.5104 | ⭐ | 
| 33 | **InterestRate_x_LTV** | 数值 | OriginalInterestRate × OriginalLTV | 0.1339 | 0.5256 | ⭐⭐ |
| 34 | **Single_Borrower_Flag** | 标志 | NumberOfBorrowers == 1 | - | - | ⭐⭐⭐ |
| 35 | **High_DTI_and_Low_CreditScore_Flag** | 标志 | (OriginalDTI > 43) & (CreditScore < 650) | - | - | ⭐⭐⭐⭐ |

**说明**：
- 这些交互特征捕捉了风险因素的组合效应
- `LTV_x_DTI` 和 `InterestRate_x_LTV` 表现较好（AUPRC > 0.13）
- **Single_Borrower_Flag**：单人贷款标志，单人贷款的违约率通常更高（缺乏共同还款人支持）
- **High_DTI_and_Low_CreditScore_Flag**：高负债低信用群体标志，识别高DTI（>43）且低信用分数（<650）的高风险群体

---

## 二、偿债压力特征 (Debt Servicing Features)

### 2.1 偿债压力特征（索引 36-40）

由 `DebtServicingFeatureBuilder` 构建，基于 DTI、LTV 和借款人数量计算。

| 索引 | 特征名称 | 类型 | 说明 | 计算公式 | AUPRC | AUROC | 重要性 |
|------|---------|------|------|----------|-------|-------|--------|
| 36 | **DTI_HighRisk_Flag** | 标志 | DTI高风险标志 | DTI > 43 | 0.1474 | 0.5712 | ⭐⭐⭐ |
| 37 | **DTI_MidRisk_Flag** | 标志 | DTI中风险标志 | 36 < DTI ≤ 43 | 0.1229 | 0.4840 | ⭐ |
| 38 | **Borrowers_Risk_Flag** | 标志 | 借款人风险标志（已删除） | NumberOfBorrowers == 1 | - | - | - |
| 39 | **BorrowerCount_Ajusted_DTI** | 数值 | 借款人数量调整后的DTI | DTI / √(NumberOfBorrowers) | 0.1392 | 0.5312 | ⭐⭐⭐ |
| 40 | **Affordability_Index** | 数值 | 综合负担能力指数 | (DTI/43) × (LTV/80) | 0.1368 | 0.5238 | ⭐⭐ |

**说明**：
- `DTI_HighRisk_Flag` 是表现最好的偿债压力特征（AUPRC=0.1474）
- `BorrowerCount_Ajusted_DTI` 考虑了借款人数量对债务负担的影响
- `Affordability_Index` 综合了DTI和LTV的风险
- `Borrowers_Risk_Flag` 已被删除（与 `Single_Borrower_Flag` 功能重复）

---

## 三、杠杆风险特征 (Leverage Risk Features)

### 3.1 杠杆风险特征（索引 42-43）

由 `LeverageFeatureBuilder` 构建，基于 EstimatedLTV 时序数据和 OriginalLTV 计算。

| 索引 | 特征名称 | 类型 | 说明 | 计算公式 | AUPRC | AUROC | 重要性 |
|------|---------|------|------|----------|-------|-------|--------|
| 42 | **LTV_Change** | 数值 | LTV变化量 | EstimatedLTV_last - OriginalLTV | 0.1308 | 0.5086 | ⭐ |
| 43 | **High_LTV_Flag** | 标志 | 高杠杆阈值标志 | OriginalLTV ≥ 95 | - | - | ⭐⭐⭐ |

**说明**：
- **LTV_Change**：捕捉了LTV从原始值到当前值的变化
- **High_LTV_Flag**：高杠杆阈值标志（OriginalLTV ≥ 95），是实务中的强风险信号
- 其他杠杆特征（如 `LTV_Change_Rate`, `EstimatedLTV_max`, `EstimatedLTV_std`, `LTV_Volatility_Rate`, `Ever_Negative_Equity`, `Negative_Equity_Flag`, `Negative_Equity_Share` 等）已被删除

---

## 四、摊销信号特征 (Amortization Signals)

### 4.1 摊销信号特征（索引 44-48）

由 `AmortizationFeatureBuilder` 构建，基于金融工程计算摊销相关特征。这些是**最重要的特征**。

| 索引 | 特征名称 | 类型 | 说明 | AUPRC | AUROC | 重要性 |
|------|---------|------|------|-------|-------|--------|
| 44 | **amort_short_mean** | 数值 | 摊销短缺平均值（预期本金 vs 实际本金） | **0.3713** | **0.6783** | ⭐⭐⭐⭐⭐ |
| 45 | **amort_short_70** | 数值 | 短缺比例 > 70% 的月份占比 | **0.3324** | **0.6362** | ⭐⭐⭐⭐⭐ |
| 46 | **amort_short_50** | 数值 | 短缺比例 > 50% 的月份占比 | **0.3278** | **0.6317** | ⭐⭐⭐⭐⭐ |
| 47 | **amort_short_std** | 数值 | 摊销短缺标准差 | 0.1303 | 0.5541 | ⭐ |
| 48 | **io_payment_count** | 数值 | 仅付利息的月份计数 | **0.3198** | **0.6246** | ⭐⭐⭐⭐⭐ |

**计算方法**：
1. 计算预期本金还款（基于年金公式）：
   ```
   P = UPB * (r * (1+r)^n) / ((1+r)^n - 1)  # 年金支付
   Expected_Principal = P - r*UPB  # 预期本金
   ```

2. 计算实际本金还款：
   ```
   Observed_Principal = UPB[t-1] - UPB[t]  # 从UPB变化推断
   ```

3. 计算短缺比例：
   ```
   Shortfall = (Expected - Observed) / Expected
   ```

4. 统计特征：
   - 平均值、标准差
   - 超过阈值（50%/70%）的月份占比
   - 仅付利息的月份计数

**说明**：
- **amort_short_mean** 是表现最好的特征（AUPRC=0.3713，AUROC=0.6783）
- 这三个特征（mean, 70, 50）在单特征评估中排名前3
- 这些特征只对 FRM 且非 IO/非 Balloon 的贷款计算，其他贷款类型设为0
- 这些特征捕捉了贷款还款行为异常，是异常检测的关键指标

### 4.2 摊销行为延伸特征（索引 49-52）

由 `AmortizationFeatureBuilder` 构建，捕捉更细粒度的还款行为模式。

| 索引 | 特征名称 | 类型 | 说明 | 计算公式 | 重要性 |
|------|---------|------|------|----------|--------|
| 49 | **Zero_Payment_Streak** | 数值 | 零支付连续月数（断供前兆） | 从后往前找最近的连续零支付月数 | 0.2693 | 0.6029 | ⭐⭐⭐ |
| 50 | **Early_Delinquency_Flag** | 数值 | 早期违约特征（前6个月未全额还款次数） | 统计前6个有效月份中，实际还款少于预期还款的次数 | 0.4999 | 0.8021 | ⭐⭐⭐⭐ |
| 51 | **Amortization_Lag** | 数值 | 摊销滞后（从贷款发放到首次还本的期数） | np.argmax(Observed > 0) | - | - | ⭐⭐⭐ |
| 52 | **Early_Payment_Trend** | 数值 | 早期支付趋势（前6个月的支付趋势） | 前6个月实际支付的线性趋势（斜率） | - | - | ⭐⭐⭐ |

**特征详细说明**：

1. **Zero_Payment_Streak**（零支付连续月数，索引 49）
   - **索引**：49
   - **计算公式**：从后往前找最近的连续零支付月数
   - **含义**：捕捉断供前兆，反映最近的还款行为
   - **解释**：值越大表示连续未还本金的月数越多，是异常贷款的强烈信号
   - **计算方式**：从时间序列的最后一个时间点往前查找，计算连续零支付的月数

2. **Early_Delinquency_Flag**（早期违约特征，索引 50）
   - **索引**：50
   - **计算公式**：统计前6个有效月份中，实际还款少于预期还款的次数
   - **含义**：识别早期就有还款问题的贷款
   - **解释**：值越大表示在贷款早期就有更多的未全额还款情况，是违约的早期预警信号
   - **计算方式**：找到前6个有效月份（预期还款 > 0），统计短缺比例 > 0.01 的月份数量
   - **阈值**：使用 0.01 作为阈值，捕捉任何未全额还款的情况

3. **Amortization_Lag**（摊销滞后，索引 51）
   - **索引**：51
   - **计算公式**：`np.argmax(Observed > 0)`，即首次还本的月份索引
   - **含义**：从贷款发放到首次还本的期数，用于识别长期仅付息（IO贷款）
   - **解释**：值越大表示首次还本的月份越晚，可能是长期仅付息的IO贷款，风险较高
   - **计算方式**：在有效月份中，找到首次实际还本（ObsPrin > 0）的月份索引；如果从未还本，设置为有效月份总数（表示长期IO状态）
   - **高风险信号**：长期仅付息的贷款（lag值很大）通常风险较高

4. **Early_Payment_Trend**（早期支付趋势，索引 52）
   - **索引**：52
   - **计算公式**：前6个月实际支付的线性趋势（斜率）
   - **含义**：捕捉贷款早期支付金额的变化趋势
   - **解释**：
     - **正斜率**：支付增加（积极信号）
     - **负斜率**：支付减少（风险信号）
     - **接近0**：支付稳定
     - **绝对值越大**：趋势变化越明显
   - **计算方式**：取前6个有效月份的实际支付金额，使用线性回归（`np.polyfit`）计算斜率

**说明**：
- 这些特征只对 FRM 且非 IO/非 Balloon 的贷款计算，其他贷款类型设为0
- `Cumulative_Shortfall` 和 `Shortfall_Volatility` 已在删除列表中，不再使用
- `Early_Delinquency_Flag` 是**高优先级特征**，用于识别早期违约风险
- `Amortization_Lag` 和 `Early_Payment_Trend` 是**中优先级特征**，用于增强模型稳健性
- 这些特征尚未进行单特征分析，性能表现待评估

---

## 五、到期风险特征 (Maturity Risk Features)

### 5.1 到期风险特征（索引 53）

由 `MaturityRiskFeatureBuilder` 构建，基于 CurrentActualUPB 和 RemainingMonthsToLegalMaturity 计算。

| 索引 | 特征名称 | 类型 | 说明 | 计算公式 | 重要性 |
|------|---------|------|------|----------|--------|
| 53 | **MaturityPressure_Index** | 数值 | 到期压力指数 | CurrentActualUPB_last / (RemainingMonthsToLegalMaturity_last + 1) | ⭐⭐⭐ |

**说明**：
- **MaturityPressure_Index**：衡量剩余本金与剩余期限的关系
- 值越高，表示剩余本金相对剩余期限越大，到期压力越大，风险越高
- 捕捉贷款到期时的还款压力

---

## 六、复合特征 (Composite Features)

### 6.1 资产波动复合特征（索引 67）

| 索引 | 特征名称 | 类型 | 说明 | 计算公式 | 重要性 |
|------|---------|------|------|----------|--------|
| 67 | **UPB_trend_x_amort_short_mean** | 数值 | 资产波动复合特征（高余额下降慢的贷款） | CurrentActualUPB_w_main_trend × amort_short_mean | ⭐⭐⭐⭐ |

**特征详细说明**：

**UPB_trend_x_amort_short_mean**（资产波动复合特征，索引 67）
- **计算公式**：`CurrentActualUPB_w_main_trend × amort_short_mean`
- **含义**：结合UPB趋势和还款行为，识别高余额但下降缓慢且还款不足的高风险贷款
- **解释**：
  - **UPB_trend**（CurrentActualUPB_w_main_trend）：当前实际未偿本金余额的趋势
    - **负值**：余额下降（正常）
    - **接近0或正值**：余额下降缓慢或增加（异常）
  - **amort_short_mean**：平均摊销短缺比例
    - **高值**：还款不足（高风险）
    - **低值**：还款正常（低风险）
- **金融意义**：
  - **高值（高风险）**：余额下降缓慢（UPB_trend接近0或为正）且还款不足（amort_short_mean高）
  - **低值（低风险）**：余额正常下降（UPB_trend为负）且还款正常（amort_short_mean低）
- **计算方式**：在 pipeline 层面计算，结合来自不同 builder 的特征（GenericTemporalBuilder 和 AmortizationFeatureBuilder）
- **实现位置**：`LoanFeaturePipeline.fit()` 和 `LoanFeaturePipeline.transform()` 方法中

**说明**：
- 这是一个跨 builder 的复合特征，在 pipeline 层面计算
- 捕捉了资产价值变化和还款行为的交互效应
- 用于识别"高余额下降慢"的高风险贷款模式
- **高优先级特征**：结合了两个重要的风险信号，理论上应该有很强的预测能力

---

## 七、时序特征 (Temporal Features)

### 7.1 CurrentNonInterestBearingUPB 时序特征（索引 53）

| 索引 | 特征名称 | 类型 | 说明 | AUPRC | AUROC | 重要性 |
|------|---------|------|------|-------|-------|--------|
| 53 | **CurrentNonInterestBearingUPB_slope_full** | 数值 | 非计息本金余额趋势（线性回归斜率） | 0.1261 | 0.5000 | ⭐ |

**说明**：
- 使用线性回归计算整个时间序列的趋势
- 捕捉非计息本金的长期变化趋势

### 7.2 CurrentActualUPB 时序特征（索引 55-66）

**CurrentActualUPB**：当前实际未偿本金余额（时序数据）

#### 多窗口统计特征：

| 索引 | 特征名称 | 窗口 | 统计量 | 说明 | AUPRC | AUROC | 重要性 |
|------|---------|------|--------|------|-------|-------|--------|
| 55 | CurrentActualUPB_w_main_trend | w_main (0,3,6,9,12) | trend | 趋势：(last-first)/(\|first\|+1) | 0.1395 | 0.5524 | ⭐⭐⭐ |
| 56 | CurrentActualUPB_w_main_vol | w_main | vol | 波动性：std/(\|mean\|+1) | 0.1347 | 0.5439 | ⭐⭐⭐ |
| 57 | CurrentActualUPB_w_main_dmean | w_main | dmean | 一阶差分均值 | 0.1411 | 0.5570 | ⭐⭐⭐ |
| 58 | CurrentActualUPB_w_main_dstd | w_main | dstd | 一阶差分标准差 | 0.1218 | 0.4918 | ⭐ |
| 59 | CurrentActualUPB_w_alt1_trend | w_alt1 (0,2,4,6,8,10,12) | trend | 趋势 | 0.1395 | 0.5524 | ⭐⭐⭐ |
| 60 | CurrentActualUPB_w_alt1_vol | w_alt1 | vol | 波动性 | 0.1366 | 0.5491 | ⭐⭐⭐ |
| 61 | CurrentActualUPB_w_alt1_dmean | w_alt1 | dmean | 一阶差分均值 | 0.1408 | 0.5565 | ⭐⭐⭐ |
| 62 | CurrentActualUPB_w_alt1_dstd | w_alt1 | dstd | 一阶差分标准差 | 0.1201 | 0.4910 | ⭐ |
| 63 | CurrentActualUPB_w_alt2_trend | w_alt2 (0,3,6,9) | trend | 趋势 | 0.1330 | 0.5374 | ⭐⭐ |
| 64 | CurrentActualUPB_w_alt2_vol | w_alt2 | vol | 波动性 | 0.1284 | 0.5217 | ⭐ |
| 65 | CurrentActualUPB_w_alt2_dmean | w_alt2 | dmean | 一阶差分均值 | 0.1311 | 0.5301 | ⭐⭐ |
| 66 | CurrentActualUPB_w_alt2_dstd | w_alt2 | dstd | 一阶差分标准差 | 0.1215 | 0.4918 | ⭐ |

**窗口策略**：
- **w_main**: 月份索引 (0, 3, 6, 9, 12) - 季度采样
- **w_alt1**: 月份索引 (0, 2, 4, 6, 8, 10, 12) - 双月采样
- **w_alt2**: 月份索引 (0, 3, 6, 9) - 季度采样（更短）

**统计量说明**：
- **trend**: `(last - first) / (|first| + 1)` - 归一化趋势
- **vol**: `std / (|mean| + 1)` - 归一化波动性
- **dmean**: 一阶差分均值 - 平均变化速度
- **dstd**: 一阶差分标准差 - 变化速度的稳定性

**说明**：
- CurrentActualUPB 是**最重要的时序特征**之一
- w_main 和 w_alt1 窗口的特征表现最好（AUPRC > 0.13）
- dmean（一阶差分均值）表现最好，说明变化速度是重要的异常信号

---

## 八、特征重要性排名（基于单特征分析）

### Top 15 特征（按AUPRC排序）

| 排名 | 特征名称 | 索引 | AUPRC | AUROC | 类别 |
|------|---------|------|-------|-------|------|
| 1 | **amort_short_mean** | 44 | 0.3713 | 0.6783 | 摊销信号 |
| 2 | **amort_short_70** | 45 | 0.3324 | 0.6362 | 摊销信号 |
| 3 | **amort_short_50** | 46 | 0.3278 | 0.6317 | 摊销信号 |
| 4 | **io_payment_count** | 48 | 0.3198 | 0.6246 | 摊销信号 |
| 5 | **CreditScore** | 0 | 0.2106 | 0.6446 | 静态特征 |
| 6 | **DTI_HighRisk_Flag** | 37 | 0.1474 | 0.5712 | 偿债压力 |
| 7 | **OriginalInterestRate** | 12 | 0.1433 | 0.5453 | 静态特征 |
| 8 | **CurrentActualUPB_w_main_dmean** | 57 | 0.1411 | 0.5570 | 时序特征 |
| 9 | **CurrentActualUPB_w_alt1_dmean** | 61 | 0.1408 | 0.5565 | 时序特征 |
| 10 | **NumberOfBorrowers** | 21 | 0.1403 | 0.5559 | 静态特征 |
| 11 | **CurrentActualUPB_w_alt1_trend** | 59 | 0.1395 | 0.5524 | 时序特征 |
| 12 | **CurrentActualUPB_w_main_trend** | 55 | 0.1395 | 0.5524 | 时序特征 |
| 13 | **BorrowerCount_Ajusted_DTI** | 40 | 0.1392 | 0.5312 | 偿债压力 |
| 14 | **Affordability_Index** | 41 | 0.1368 | 0.5238 | 偿债压力 |
| 15 | **LTV_x_DTI** | 32 | 0.1368 | 0.5238 | 静态交互 |

### 核心检测器性能（基于原始特征值）

基于三个核心特征构建的独立检测器在验证集上的表现：

| 检测器 | 特征名称 | 索引 | AUPRC | AUROC | 说明 |
|--------|---------|------|-------|-------|------|
| **检测器 1 (王牌)** | Early_Delinquency_Flag | 50 | **0.4999** | **0.8021** | 早期违约检测器，表现最佳 |
| **检测器 2 (二号王牌)** | amort_short_mean | 44 | **0.4749** | **0.7525** | 摊销短缺检测器，表现优异 |
| **检测器 3 (三号王牌)** | Zero_Payment_Streak | 49 | 0.2693 | 0.6029 | 零支付连续月数检测器 |

**注意**：
- 单特征分析结果基于 IsolationForest 模型在单个特征上的表现
- 检测器性能基于直接使用特征原始值作为异常分数
- Early_Delinquency_Flag 作为独立检测器表现最佳（AUPRC=0.4999）
- 融合模型（4个检测器加权组合）在验证集上的性能：**AUPRC=0.5820, AUROC=0.8203**

### 特征重要性分级

- **⭐⭐⭐⭐⭐ (AUPRC > 0.30)**：摊销信号特征（amort_short_mean, amort_short_50, amort_short_70, io_payment_count）
- **⭐⭐⭐⭐ (AUPRC > 0.20)**：CreditScore
- **⭐⭐⭐ (AUPRC > 0.13)**：DTI_HighRisk_Flag, OriginalInterestRate, CurrentActualUPB时序特征, NumberOfBorrowers, BorrowerCount_Ajusted_DTI, LTV_x_DTI
- **⭐⭐⭐ (检测器AUPRC > 0.40)**：Early_Delinquency_Flag（检测器AUPRC=0.4999），amort_short_mean（检测器AUPRC=0.4749）
- **⭐⭐ (AUPRC > 0.12)**：其他有价值的特征
- **⭐ (AUPRC ≈ 0.12-0.13)**：表现接近随机的特征

**融合模型性能**：
- **融合模型（4个检测器加权组合）**：AUPRC=0.5820, AUROC=0.8203（验证集）
- 融合模型显著优于单个检测器，推荐使用

---

## 九、特征生成方法

### 8.1 Sentinel值处理

将特殊值转换为NaN：
- **数值型**：999, 9999 → NaN
- **标志型**：'9', '99' → NaN

### 8.2 分类变量编码

- 使用 `LabelEncoder` 进行编码
- 支持 "UNKNOWN" 值处理（测试集中出现训练集中没有的类别）
- 缺失值用 "MISSING" 表示

### 8.3 数值变量填充

- 使用中位数填充缺失值
- 对每个特征独立计算中位数

### 8.4 特征构建器

特征工程采用模块化设计，使用多个特征构建器：

1. **StaticFeatureBuilder**：处理静态特征、交互特征和借款人结构风险特征（Single_Borrower_Flag）
2. **DebtServicingFeatureBuilder**：生成偿债压力特征
3. **LeverageFeatureBuilder**：生成杠杆风险特征（包括High_LTV_Flag）
4. **AmortizationFeatureBuilder**：生成摊销信号特征
5. **BalanceFeatureBuilder**：生成余额趋势特征
6. **MaturityRiskFeatureBuilder**：生成到期风险特征（MaturityPressure_Index）
7. **GenericTemporalBuilder**：生成通用时序统计特征

### 8.5 特征标准化

使用 **RobustScaler**（基于中位数和IQR）：
- 对异常值更鲁棒
- 适合金融数据中的异常值
- 公式：`(x - median) / IQR`

---

## 九、特征删除列表

以下特征会被自动删除（低价值或噪声特征）：

### 9.1 Missing Flags（全部删除）
- 所有 `*_missing` 标志列

### 9.2 噪声类时序特征（AUPRC≈0.126）
- LoanAge 的所有窗口特征
- MonthlyReportingPeriod 的所有窗口特征
- CurrentInterestRate 的所有窗口特征
- CurrentNonInterestBearingUPB 的所有窗口特征
- InterestBearingUPB 的所有窗口特征
- RemainingMonthsToLegalMaturity 的所有窗口特征

### 9.3 杠杆特征（部分删除）
- EstimatedLTV_last_val（辅助列）
- LTV_Change_Rate
- EstimatedLTV_std
- LTV_Volatility_Rate（已在删除列表中）
- EstimatedLTV_max
- Negative_Equity_Flag（房贷倒挂风险标志，已在删除列表中）
- Ever_Negative_Equity
- Negative_Equity_Share

**保留的杠杆特征**：
- LTV_Change（LTV变化量）
- High_LTV_Flag（高杠杆阈值标志，OriginalLTV ≥ 95）

### 9.4 其他无效列
- amort_mask_not_applicable
- Borrowers_Risk_Flag（在删除列表中，与Single_Borrower_Flag功能重复）
- Cumulative_Shortfall（累积短缺，已在删除列表中）
- Shortfall_Volatility（短缺波动性，已在删除列表中）

---

## 十一、特征统计信息

- **总特征数**：69个（删除后约55个）
- **静态特征**：36个（31个原始列 + 3个交互特征 + 1个借款人结构风险特征 + 1个信用行为特征，索引 0-35）
- **偿债压力特征**：4个（索引 37, 38, 40, 41，Borrowers_Risk_Flag（索引39）已删除）
- **杠杆风险特征**：2个（索引 42-43，LTV_Change 和 High_LTV_Flag）
- **摊销特征**：9个（5个基础特征：索引 44-48 + 4个延伸特征：索引 49-52）
  - 基础特征：amort_short_mean, amort_short_70, amort_short_50, amort_short_std, io_payment_count
  - 延伸特征：Zero_Payment_Streak, Early_Delinquency_Flag, Amortization_Lag, Early_Payment_Trend
- **时序特征（Balance）**：1个（索引 53，CurrentNonInterestBearingUPB_slope_full）
- **到期风险特征**：1个（索引 54，MaturityPressure_Index）
- **时序特征（CurrentActualUPB）**：12个（索引 55-66）
- **复合特征**：1个（索引 67，UPB_trend_x_amort_short_mean）
- **最佳特征（单特征分析）**：amort_short_mean (AUPRC=0.3713)
- **最佳检测器（原始特征值）**：Early_Delinquency_Flag (检测器AUPRC=0.4999)
- **最佳模型（融合）**：融合模型 (AUPRC=0.5820, AUROC=0.8203)
- **最差特征**：多个特征 AUPRC ≈ 0.12（接近随机）

**新增特征**：
- Single_Borrower_Flag（索引 34）：借款人结构风险特征
- High_DTI_and_Low_CreditScore_Flag（索引 35）：信用行为特征（高负债低信用群体）- **高优先级**
- High_LTV_Flag（索引 43）：杠杆极端化风险特征（高杠杆阈值标志，OriginalLTV ≥ 95）
- MaturityPressure_Index（索引 54）：到期风险特征
- Zero_Payment_Streak（索引 49）：摊销行为延伸特征（零支付连续月数）
- Early_Delinquency_Flag（索引 50）：早期违约特征（前6个月未全额还款次数）- **高优先级**
- Amortization_Lag（索引 51）：摊销滞后特征（从贷款发放到首次还本的期数）- **中优先级**
- Early_Payment_Trend（索引 52）：早期支付趋势特征（前6个月的支付趋势斜率）- **中优先级**
- UPB_trend_x_amort_short_mean（索引 67）：资产波动复合特征（高余额下降慢的贷款）- **高优先级**

---

## 十二、使用建议

### 12.1 特征选择

基于单特征分析和检测器性能：
1. **必须保留**：所有摊销信号特征（amort_short_mean, amort_short_50, amort_short_70, io_payment_count）
2. **核心检测器特征（强烈推荐）**：
   - **Early_Delinquency_Flag**（检测器AUPRC=0.4999）- 王牌检测器
   - **amort_short_mean**（检测器AUPRC=0.4749）- 二号王牌检测器
   - **Zero_Payment_Streak**（检测器AUPRC=0.2693）- 三号王牌检测器
3. **强烈推荐**：新增特征（High_DTI_and_Low_CreditScore_Flag, High_LTV_Flag, Single_Borrower_Flag, MaturityPressure_Index, UPB_trend_x_amort_short_mean）
4. **推荐**：增强特征（Amortization_Lag, Early_Payment_Trend）- 用于增强模型稳健性
5. **强烈推荐**：CreditScore, DTI_HighRisk_Flag, CurrentActualUPB时序特征, OriginalInterestRate
6. **推荐**：NumberOfBorrowers, BorrowerCount_Ajusted_DTI, LTV_x_DTI, Affordability_Index
7. **可考虑删除**：AUPRC < 0.13 的特征（表现接近随机）

### 12.2 模型训练建议

1. **特征重要性**：摊销信号特征是最重要的，应该优先使用
2. **特征组合**：静态特征 + 偿债压力特征 + 时序特征 + 摊销特征的组合效果最好
3. **模型选择**：
   - **单模型**：基于 baseline.py 的评估，LOF (k=15, metric='manhattan') 表现较好
   - **融合模型（推荐）**：融合4个检测器（Early_Delinquency_Flag, amort_short_mean, Zero_Payment_Streak, LOF_k50）可获得最佳性能
     - 融合模型性能：**AUPRC=0.5820, AUROC=0.8203**
     - 融合权重：Early_Delinquency_Flag (40%), amort_short_mean (30%), Zero_Payment_Streak (10%), LOF_k50 (20%)
4. **训练数据**：只在正常样本（target==0）上训练异常检测模型
5. **评估指标**：使用 AUPRC 和 AUROC 评估模型性能

### 12.3 融合模型使用

**推荐使用融合模型**，它结合了4个检测器的优势：
- **Early_Delinquency_Flag 检测器**：捕捉早期违约信号（AUPRC=0.4999）
- **amort_short_mean 检测器**：捕捉还款不足信号（AUPRC=0.4749）
- **Zero_Payment_Streak 检测器**：捕捉断供前兆（AUPRC=0.2693）
- **LOF(k=50) 检测器**：捕捉全局异常模式

融合后的性能（验证集）：
- **AUPRC = 0.5820**（比单个检测器提升约16%）
- **AUROC = 0.8203**（表现优异）

使用方法：运行 `final_models/run_fusion_ensemble.py` 脚本即可生成融合模型预测结果。

---

## 十三、文件输出

特征工程脚本会生成以下文件：

- `train_scaled.npy`：训练集标准化特征矩阵
- `valid_scaled.npy`：验证集标准化特征矩阵
- `test_scaled.npy`：测试集标准化特征矩阵
- `train_labels.npy`：训练集标签
- `valid_labels.npy`：验证集标签
- `test_ids.npy`：测试集ID
- `feature_names.txt`：特征名称列表（69个特征，删除后约55个）

---

## 十四、更新记录

- **2024-XX-XX**：采用模块化特征构建器设计
- **2024-XX-XX**：添加偿债压力特征构建器
- **2024-XX-XX**：添加杠杆风险特征构建器
- **2024-XX-XX**：移除PCA降维，只生成标准化特征
- **2024-XX-XX**：添加特征删除功能
- **2024-XX-XX**：使用RobustScaler替代StandardScaler
- **2024-XX-XX**：添加借款人结构风险特征（Single_Borrower_Flag）
- **2024-XX-XX**：添加杠杆极端化风险特征（High_LTV_Flag）
- **2024-XX-XX**：添加到期风险特征构建器（MaturityPressure_Index）
- **2024-XX-XX**：更新特征删除列表，移除低价值特征
- **2024-XX-XX**：添加早期违约特征（Early_Delinquency_Flag）- 高优先级特征，识别早期违约风险
- **2024-XX-XX**：添加摊销滞后特征（Amortization_Lag）- 中优先级特征，识别长期仅付息贷款
- **2024-XX-XX**：添加早期支付趋势特征（Early_Payment_Trend）- 中优先级特征，捕捉早期支付变化趋势
- **2024-XX-XX**：添加信用行为特征（High_DTI_and_Low_CreditScore_Flag）- 高优先级特征，识别高负债低信用群体
- **2024-XX-XX**：添加资产波动复合特征（UPB_trend_x_amort_short_mean）- 高优先级特征，识别高余额下降慢的贷款
- **2024-XX-XX**：更新检测器性能数据（基于原始特征值的独立检测器评估）
- **2024-XX-XX**：添加融合模型性能数据（AUPRC=0.5820, AUROC=0.8203）

---

## 附录：特征索引映射

完整的特征索引到名称的映射，请参考 `data/feature_advanced/feature_names.txt` 文件。

### 特征索引快速参考

- **0-30**：静态特征（原始列）
- **31-35**：静态交互特征和借款人结构风险特征（LTV_x_DTI, UPB_per_CreditScore, InterestRate_x_LTV, Single_Borrower_Flag, High_DTI_and_Low_CreditScore_Flag）
- **37-41**：偿债压力特征（DTI_HighRisk_Flag（索引37）, DTI_MidRisk_Flag（索引38）, BorrowerCount_Ajusted_DTI（索引40）, Affordability_Index（索引41），Borrowers_Risk_Flag（索引39）已删除）
- **42-43**：杠杆风险特征（LTV_Change（索引42）, High_LTV_Flag（索引43））
- **44-48**：摊销信号特征（基础：amort_short_mean, amort_short_70, amort_short_50, amort_short_std, io_payment_count）
- **49-52**：摊销行为延伸特征（Zero_Payment_Streak, Early_Delinquency_Flag, Amortization_Lag, Early_Payment_Trend）
- **53**：CurrentNonInterestBearingUPB时序特征
- **54**：到期风险特征（MaturityPressure_Index）
- **55-66**：CurrentActualUPB时序特征
- **67**：资产波动复合特征（UPB_trend_x_amort_short_mean）
