# 特征工程说明文档

## 概述

本文档详细说明特征工程脚本 (`feature_generator.py`) 生成的所有特征。特征工程流程包括：
1. Sentinel值处理（将特殊值转为NaN）
2. 分类变量编码（LabelEncoder）
3. 数值变量填充（中位数）
4. 时序特征提取（多窗口统计）
5. 摊销信号计算（金融工程）
6. 特征删除（移除低价值特征）
7. 标准化（RobustScaler）

**最终特征数量**：68个特征

---

## 一、静态特征 (Static Features)

### 1.1 原始静态列（经过编码/填充处理）

| 特征名称 | 索引 | 类型 | 说明 | AUPRC | AUROC | 重要性 |
|---------|------|------|------|-------|-------|--------|
| **CreditScore** | 0 | 数值 | 借款人信用分数 (300-850)，Sentinel值9999已处理 | 0.2106 | 0.6446 | ⭐⭐⭐⭐ |
| **FirstPaymentDate** | 1 | 日期 | 首次还款日期 (YYYYMM格式) | 0.1261 | 0.5002 | ⭐ |
| **FirstTimeHomebuyerFlag** | 2 | 分类 | 首次购房者标志 (Y/N/9)，已编码 | 0.1209 | 0.4733 | ⭐ |
| **MaturityDate** | 3 | 日期 | 贷款到期日期 (YYYYMM格式) | 0.1246 | 0.4900 | ⭐ |
| **MSA** | 4 | 分类 | 大都市统计区代码 | 0.1233 | 0.4896 | ⭐ |
| **MI_Pct** | 5 | 数值 | 抵押保险百分比 (0-55%，999=不可用)，已处理 | 0.1286 | 0.5123 | ⭐ |
| **NumberOfUnits** | 6 | 数值 | 住宅单元数 (1-4) | 0.1277 | 0.5054 | ⭐ |
| **OccupancyStatus** | 7 | 分类 | 占用状态 (P/I/S/9)，已编码 | 0.1266 | 0.5033 | ⭐ |
| **OriginalCLTV** | 8 | 数值 | 原始合并贷款价值比 | 0.1264 | 0.5046 | ⭐ |
| **OriginalDTI** | 9 | 数值 | 原始债务收入比 (%)，Sentinel值999已处理 | 0.1244 | 0.4941 | ⭐ |
| **OriginalUPB** | 10 | 数值 | 原始未偿本金余额 | 0.1272 | 0.5074 | ⭐ |
| **OriginalLTV** | 11 | 数值 | 原始贷款价值比，Sentinel值999已处理 | 0.1261 | 0.5086 | ⭐ |
| **OriginalInterestRate** | 12 | 数值 | 原始利率 | 0.1433 | 0.5453 | ⭐⭐⭐ |
| **Channel** | 13 | 分类 | 贷款渠道 (R/B/C/T/9)，已编码 | 0.1313 | 0.5173 | ⭐⭐ |
| **PPM_Flag** | 14 | 分类 | 提前还款罚金标志 (Y/N)，已编码 | 0.1261 | 0.5000 | ⭐ |
| **ProductType** | 15 | 分类 | 产品类型 (FRM/ARM)，已编码 | 0.1261 | 0.5000 | ⭐ |
| **PropertyState** | 16 | 分类 | 房产所在州（两字母代码），已编码 | 0.1261 | 0.4902 | ⭐ |
| **PropertyType** | 17 | 分类 | 房产类型 (SF/CO/PU/MH/CP/99)，已编码 | 0.1224 | 0.4705 | ⭐ |
| **PostalCode** | 18 | 分类 | 邮政编码，已编码 | 0.1208 | 0.4766 | ⭐ |
| **LoanPurpose** | 19 | 分类 | 贷款用途，已编码 | 0.1329 | 0.5280 | ⭐⭐ |
| **OriginalLoanTerm** | 20 | 数值 | 原始贷款期限（月） | 0.1248 | 0.4898 | ⭐ |
| **NumberOfBorrowers** | 21 | 数值 | 借款人数量 | 0.1403 | 0.5559 | ⭐⭐⭐ |
| **SellerName** | 22 | 分类 | 卖方名称，已编码 | 0.1223 | 0.4810 | ⭐ |
| **ServicerName** | 23 | 分类 | 服务商名称，已编码 | 0.1246 | 0.4981 | ⭐ |
| **SuperConformingFlag** | 24 | 分类 | 超级合格标志，已编码 | 0.1259 | 0.4962 | ⭐ |
| **PreHARP_Flag** | 25 | 分类 | Pre-HARP标志，已编码 | 0.1261 | 0.5000 | ⭐ |
| **ProgramIndicator** | 26 | 分类 | 项目指示器，已编码 | 0.1289 | 0.5114 | ⭐ |
| **ReliefRefinanceIndicator** | 27 | 分类 | 救济再融资指示器，已编码 | 0.1261 | 0.5000 | ⭐ |
| **PropertyValMethod** | 28 | 分类 | 房产估值方法，已编码 | 0.1263 | 0.4847 | ⭐ |
| **InterestOnlyFlag** | 29 | 分类 | 仅付利息标志 (Y/N)，已编码 | 0.1261 | 0.5000 | ⭐ |
| **BalloonIndicator** | 30 | 分类 | 气球贷款标志 (Y/N)，已编码 | 0.1290 | 0.5124 | ⭐ |

### 1.2 静态交互特征（新增）

| 特征名称 | 索引 | 类型 | 计算公式 | AUPRC | AUROC | 重要性 |
|---------|------|------|----------|-------|-------|--------|
| **LTV_x_DTI** | 31 | 数值 | OriginalLTV × OriginalDTI | 0.1368 | 0.5238 | ⭐⭐⭐ |
| **UPB_per_CreditScore** | 32 | 数值 | OriginalUPB / (CreditScore + 1) | 0.1296 | 0.5104 | ⭐ |
| **InterestRate_x_LTV** | 33 | 数值 | OriginalInterestRate × OriginalLTV | 0.1339 | 0.5256 | ⭐⭐ |

**说明**：
- 这些交互特征捕捉了风险因素的组合效应
- LTV_x_DTI 和 InterestRate_x_LTV 表现较好（AUPRC > 0.13）

---

## 二、时序特征 (Temporal Features)

### 2.1 CurrentActualUPB 时序特征

**CurrentActualUPB**：当前实际未偿本金余额（时序数据）

#### 多窗口统计特征：

| 特征名称 | 索引 | 窗口 | 统计量 | 说明 | AUPRC | AUROC | 重要性 |
|---------|------|------|--------|------|-------|-------|--------|
| CurrentActualUPB_w_main_trend | 34 | w_main (0,3,6,9,12) | trend | 趋势：(last-first)/(\|first\|+1) | 0.1395 | 0.5524 | ⭐⭐⭐ |
| CurrentActualUPB_w_main_vol | 35 | w_main | vol | 波动性：std/(\|mean\|+1) | 0.1347 | 0.5439 | ⭐⭐⭐ |
| CurrentActualUPB_w_main_dmean | 36 | w_main | dmean | 一阶差分均值 | 0.1411 | 0.5570 | ⭐⭐⭐ |
| CurrentActualUPB_w_main_dstd | 37 | w_main | dstd | 一阶差分标准差 | 0.1218 | 0.4918 | ⭐ |
| CurrentActualUPB_w_alt1_trend | 38 | w_alt1 (0,2,4,6,8,10,12) | trend | 趋势 | 0.1395 | 0.5524 | ⭐⭐⭐ |
| CurrentActualUPB_w_alt1_vol | 39 | w_alt1 | vol | 波动性 | 0.1366 | 0.5491 | ⭐⭐⭐ |
| CurrentActualUPB_w_alt1_dmean | 40 | w_alt1 | dmean | 一阶差分均值 | 0.1408 | 0.5565 | ⭐⭐⭐ |
| CurrentActualUPB_w_alt1_dstd | 41 | w_alt1 | dstd | 一阶差分标准差 | 0.1201 | 0.4910 | ⭐ |
| CurrentActualUPB_w_alt2_trend | 42 | w_alt2 (0,3,6,9) | trend | 趋势 | 0.1330 | 0.5374 | ⭐⭐ |
| CurrentActualUPB_w_alt2_vol | 43 | w_alt2 | vol | 波动性 | 0.1284 | 0.5217 | ⭐ |
| CurrentActualUPB_w_alt2_dmean | 44 | w_alt2 | dmean | 一阶差分均值 | 0.1311 | 0.5301 | ⭐⭐ |
| CurrentActualUPB_w_alt2_dstd | 45 | w_alt2 | dstd | 一阶差分标准差 | 0.1215 | 0.4918 | ⭐ |

**说明**：
- CurrentActualUPB 是**最重要的时序特征**之一
- w_main 和 w_alt1 窗口的特征表现最好（AUPRC > 0.13）
- dmean（一阶差分均值）表现最好，说明变化速度是重要的异常信号

### 2.2 CurrentNonInterestBearingUPB 时序特征

| 特征名称 | 索引 | 类型 | 说明 | AUPRC | AUROC | 重要性 |
|---------|------|------|------|-------|-------|--------|
| **CurrentNonInterestBearingUPB_slope_full** | 46 | 数值 | 非计息本金余额趋势（线性回归斜率） | 0.1261 | 0.5000 | ⭐ |

**说明**：
- 使用线性回归计算整个时间序列的趋势
- 捕捉非计息本金的长期变化趋势

### 2.3 EstimatedLTV 时序特征

#### 特殊统计特征：

| 特征名称 | 索引 | 类型 | 说明 | AUPRC | AUROC | 重要性 |
|---------|------|------|------|-------|-------|--------|
| **EstimatedLTV_max** | 47 | 数值 | EstimatedLTV的最大值 | 0.1229 | 0.4964 | ⭐ |
| **EstimatedLTV_std** | 48 | 数值 | EstimatedLTV的标准差（波动性） | 0.1260 | 0.4829 | ⭐ |
| **EstimatedLTV_last_val** | 49 | 数值 | EstimatedLTV的最后一个值 | 0.1274 | 0.5027 | ⭐ |

#### 多窗口统计特征：

| 特征名称 | 索引 | 窗口 | 统计量 | AUPRC | AUROC | 重要性 |
|---------|------|------|--------|-------|-------|--------|
| EstimatedLTV_w_main_trend | 50 | w_main | trend | 0.1239 | 0.4904 | ⭐ |
| EstimatedLTV_w_main_vol | 51 | w_main | vol | 0.1221 | 0.4831 | ⭐ |
| EstimatedLTV_w_main_dmean | 52 | w_main | dmean | 0.1244 | 0.4886 | ⭐ |
| EstimatedLTV_w_main_dstd | 53 | w_main | dstd | 0.1258 | 0.4883 | ⭐ |
| EstimatedLTV_w_alt1_trend | 54 | w_alt1 | trend | 0.1239 | 0.4904 | ⭐ |
| EstimatedLTV_w_alt1_vol | 55 | w_alt1 | vol | 0.1232 | 0.4822 | ⭐ |
| EstimatedLTV_w_alt1_dmean | 56 | w_alt1 | dmean | 0.1271 | 0.4876 | ⭐ |
| EstimatedLTV_w_alt1_dstd | 57 | w_alt1 | dstd | 0.1267 | 0.4855 | ⭐ |
| EstimatedLTV_w_alt2_trend | 58 | w_alt2 | trend | 0.1229 | 0.4887 | ⭐ |
| EstimatedLTV_w_alt2_vol | 59 | w_alt2 | vol | 0.1267 | 0.4981 | ⭐ |
| EstimatedLTV_w_alt2_dmean | 60 | w_alt2 | dmean | 0.1212 | 0.4845 | ⭐ |
| EstimatedLTV_w_alt2_dstd | 61 | w_alt2 | dstd | 0.1235 | 0.4856 | ⭐ |

**说明**：
- EstimatedLTV 特征的表现相对较弱（AUPRC ≈ 0.12-0.13）
- 这些特征在删除列表中，但当前代码中已取消注释，所以仍被保留

---

## 三、摊销信号特征 (Amortization Signals)

基于金融工程计算的摊销相关特征，这些是**最重要的特征**。

| 特征名称 | 索引 | 类型 | 说明 | AUPRC | AUROC | 重要性 |
|---------|------|------|------|-------|-------|--------|
| **amort_short_mean** | 62 | 数值 | 摊销短缺平均值（预期本金 vs 实际本金） | **0.3713** | **0.6783** | ⭐⭐⭐⭐⭐ |
| **amort_short_70** | 63 | 数值 | 短缺比例 > 70% 的月份占比 | **0.3324** | **0.6362** | ⭐⭐⭐⭐⭐ |
| **amort_short_50** | 64 | 数值 | 短缺比例 > 50% 的月份占比 | **0.3278** | **0.6317** | ⭐⭐⭐⭐⭐ |
| **amort_short_std** | 65 | 数值 | 摊销短缺标准差 | 0.1303 | 0.5541 | ⭐ |
| **io_payment_count** | 66 | 数值 | 仅付利息的月份计数 | **0.3198** | **0.6246** | ⭐⭐⭐⭐⭐ |

**计算方法**：
1. 计算预期本金还款（基于年金公式）
2. 计算实际本金还款（从UPB变化推断）
3. 计算短缺比例：`(Expected - Observed) / Expected`
4. 统计短缺比例 > 阈值（50%/70%）的月份占比

**说明**：
- **amort_short_mean** 是表现最好的特征（AUPRC=0.3713，AUROC=0.6783）
- 这三个特征（mean, 70, 50）在单特征评估中排名前3
- 这些特征只对 FRM 且非 IO/非 Balloon 的贷款计算，其他贷款类型设为0
- 这些特征捕捉了贷款还款行为异常，是异常检测的关键指标

---

## 四、特征重要性排名（基于单特征分析）

### Top 10 特征（按AUPRC排序）

| 排名 | 特征名称 | AUPRC | AUROC | 类别 |
|------|---------|-------|-------|------|
| 1 | **amort_short_mean** | 0.3713 | 0.6783 | 摊销信号 |
| 2 | **amort_short_50** | 0.3324 | 0.6362 | 摊销信号 |
| 3 | **amort_short_70** | 0.3278 | 0.6317 | 摊销信号 |
| 4 | **io_payment_count** | 0.3198 | 0.6246 | 摊销信号 |
| 5 | **CreditScore** | 0.2106 | 0.6446 | 静态特征 |
| 6 | **OriginalInterestRate** | 0.1433 | 0.5453 | 静态特征 |
| 7 | **CurrentActualUPB_w_main_dmean** | 0.1411 | 0.5570 | 时序特征 |
| 8 | **CurrentActualUPB_w_alt1_dmean** | 0.1408 | 0.5565 | 时序特征 |
| 9 | **NumberOfBorrowers** | 0.1403 | 0.5559 | 静态特征 |
| 10 | **CurrentActualUPB_w_main_trend** | 0.1395 | 0.5524 | 时序特征 |

### 特征重要性分级

- **⭐⭐⭐⭐⭐ (AUPRC > 0.30)**：摊销信号特征（amort_short_mean, amort_short_50, amort_short_70, io_payment_count）
- **⭐⭐⭐⭐ (AUPRC > 0.20)**：CreditScore
- **⭐⭐⭐ (AUPRC > 0.13)**：OriginalInterestRate, CurrentActualUPB时序特征, NumberOfBorrowers, LTV_x_DTI
- **⭐⭐ (AUPRC > 0.12)**：其他有价值的特征
- **⭐ (AUPRC ≈ 0.12-0.13)**：表现接近随机的特征

---

## 五、特征生成方法

### 5.1 Sentinel值处理

将特殊值转换为NaN并创建缺失标志：
- **数值型**：999, 9999 → NaN
- **标志型**：'9', '99' → NaN

### 5.2 分类变量编码

- 使用 `LabelEncoder` 进行编码
- 支持 "UNKNOWN" 值处理（测试集中出现训练集中没有的类别）

### 5.3 时序特征提取

**多窗口策略**：
- **w_main**: 月份索引 (0, 3, 6, 9, 12) - 季度采样
- **w_alt1**: 月份索引 (0, 2, 4, 6, 8, 10, 12) - 双月采样
- **w_alt2**: 月份索引 (0, 3, 6, 9) - 季度采样（更短）

**每个窗口生成的统计量**：
- **trend**: `(last - first) / (|first| + 1)` - 归一化趋势
- **vol**: `std / (|mean| + 1)` - 归一化波动性
- **dmean**: 一阶差分均值 - 平均变化速度
- **dstd**: 一阶差分标准差 - 变化速度的稳定性

### 5.4 摊销信号计算

**金融工程方法**：
1. 计算预期本金还款（基于年金公式）：
   ```
   P = UPB * (r * (1+r)^n) / ((1+r)^n - 1)  # 年金支付
   Expected_Principal = P - r*UPB  # 预期本金
   ```

2. 计算实际本金还款：
   ```
   Observed_Principal = UPB[t-1] - UPB[t]  # 从UPB变化推断
   ```

3. 计算短缺比例：
   ```
   Shortfall = (Expected - Observed) / Expected
   ```

4. 统计特征：
   - 平均值、标准差
   - 超过阈值（50%, 70%）的月份占比
   - 仅付利息的月份计数

### 5.5 特征标准化

使用 **RobustScaler**（基于中位数和IQR）：
- 对异常值更鲁棒
- 适合金融数据中的异常值

---

## 六、特征删除列表

以下特征会被自动删除（低价值或噪声特征）：

### 6.1 Missing Flags（全部删除）
- 所有 `*_missing` 标志列

### 6.2 噪声类时序特征（AUPRC≈0.126）
- LoanAge 的所有窗口特征
- MonthlyReportingPeriod 的所有窗口特征
- CurrentInterestRate 的所有窗口特征
- CurrentNonInterestBearingUPB 的所有窗口特征
- InterestBearingUPB 的所有窗口特征
- RemainingMonthsToLegalMaturity 的所有窗口特征

### 6.3 其他无效列
- amort_mask_not_applicable
- LTV_Change

**注意**：当前代码中，部分删除列表被注释掉了（如EstimatedLTV系列、弱静态变量），所以这些特征目前仍被保留。

---

## 七、特征统计信息

- **总特征数**：68个
- **静态特征**：34个（31个原始列 + 3个交互特征）
- **时序特征**：29个（CurrentActualUPB: 12个 + EstimatedLTV: 15个 + 特殊特征: 2个）
- **摊销特征**：5个
- **最佳特征**：amort_short_mean (AUPRC=0.3713)
- **最差特征**：多个特征 AUPRC ≈ 0.12（接近随机）

---

## 八、使用建议

### 8.1 特征选择

基于单特征分析结果：
1. **必须保留**：所有摊销信号特征（amort_short_mean, amort_short_50, amort_short_70, io_payment_count）
2. **强烈推荐**：CreditScore, CurrentActualUPB时序特征, OriginalInterestRate
3. **推荐**：NumberOfBorrowers, LTV_x_DTI, InterestRate_x_LTV
4. **可考虑删除**：AUPRC < 0.13 的特征（表现接近随机）

### 8.2 模型训练建议

1. **特征重要性**：摊销信号特征是最重要的，应该优先使用
2. **特征组合**：静态特征 + 时序特征 + 摊销特征的组合效果最好
3. **标准化**：使用RobustScaler对异常值更鲁棒
4. **特征工程**：可以考虑基于重要性排名进行特征选择

---

## 九、文件输出

特征工程脚本会生成以下文件：

- `train_scaled.npy`：训练集标准化特征矩阵
- `valid_scaled.npy`：验证集标准化特征矩阵
- `test_scaled.npy`：测试集标准化特征矩阵
- `train_labels.npy`：训练集标签
- `valid_labels.npy`：验证集标签
- `test_ids.npy`：测试集ID
- `feature_names.txt`：特征名称列表

---

## 十、更新记录

- **2024-XX-XX**：移除PCA降维，只生成标准化特征
- **2024-XX-XX**：添加特征删除功能
- **2024-XX-XX**：添加静态交互特征
- **2024-XX-XX**：添加摊销信号特征
- **2024-XX-XX**：使用RobustScaler替代StandardScaler

---

## 附录：特征索引映射

完整的特征索引到名称的映射，请参考 `data/feature_advanced/feature_names.txt` 文件。

