# Feature Engineering Documentation (English Edition)

## Overview

This document describes every feature produced by `feature_generator.py`. The feature pipeline adopts a modular builder pattern that includes the following components:

1. **StaticFeatureBuilder**
2. **DebtServicingFeatureBuilder**
3. **LeverageFeatureBuilder**
4. **AmortizationFeatureBuilder**
5. **BalanceFeatureBuilder**
6. **MaturityRiskFeatureBuilder**
7. **GenericTemporalBuilder**

**Final Feature Count**: 67 columns

**Processing Stages**:

1. Handle sentinel values (map special codes to NaN)
2. Encode categorical variables (`LabelEncoder`)
3. Impute numerical variables with the median
4. Generate engineered features (builder modules)
5. Drop low-value columns
6. Scale features with `RobustScaler`

---

## 1. Static Features

### 1.1 Raw Static Columns (Index 0–30)

| Idx | Feature | Type | Notes | AUPRC | AUROC | Importance |
|-----|---------|------|-------|-------|-------|------------|
| 0 | **CreditScore** | Numeric | Borrower credit score (300–850). Sentinel 9999 mapped to NaN | 0.2106 | 0.6446 | ⭐⭐⭐⭐ |
| 1 | **FirstPaymentDate** | Date | First scheduled payment (YYYYMM) | 0.1261 | 0.5002 | ⭐ |
| 2 | **FirstTimeHomebuyerFlag** | Categorical | Y/N/9 indicator; label-encoded | 0.1209 | 0.4733 | ⭐ |
| 3 | **MaturityDate** | Date | Loan maturity date (YYYYMM) | 0.1246 | 0.4900 | ⭐ |
| 4 | **MSA** | Categorical | Metropolitan statistical area code | 0.1233 | 0.4896 | ⭐ |
| 5 | **MI_Pct** | Numeric | Mortgage insurance percentage (0–55%, 999 → NaN) | 0.1286 | 0.5123 | ⭐ |
| 6 | **NumberOfUnits** | Numeric | Number of housing units (1–4) | 0.1277 | 0.5054 | ⭐ |
| 7 | **OccupancyStatus** | Categorical | P/I/S/9; label-encoded | 0.1266 | 0.5033 | ⭐ |
| 8 | **OriginalCLTV** | Numeric | Original combined LTV | 0.1264 | 0.5046 | ⭐ |
| 9 | **OriginalDTI** | Numeric | Debt-to-income ratio (%). Sentinel 999 → NaN | 0.1244 | 0.4941 | ⭐ |
| 10 | **OriginalUPB** | Numeric | Original unpaid principal balance | 0.1272 | 0.5074 | ⭐ |
| 11 | **OriginalLTV** | Numeric | Original loan-to-value. Sentinel 999 → NaN | 0.1261 | 0.5086 | ⭐ |
| 12 | **OriginalInterestRate** | Numeric | Original note rate | 0.1433 | 0.5453 | ⭐⭐⭐ |
| 13 | **Channel** | Categorical | Origination channel (R/B/C/T/9) | 0.1313 | 0.5173 | ⭐⭐ |
| 14 | **PPM_Flag** | Categorical | Prepayment penalty indicator | 0.1261 | 0.5000 | ⭐ |
| 15 | **ProductType** | Categorical | FRM/ARM | 0.1261 | 0.5000 | ⭐ |
| 16 | **PropertyState** | Categorical | State/territory code | 0.1261 | 0.4902 | ⭐ |
| 17 | **PropertyType** | Categorical | SF/CO/PU/MH/CP/99 | 0.1224 | 0.4705 | ⭐ |
| 18 | **PostalCode** | Categorical | Masked ZIP code | 0.1208 | 0.4766 | ⭐ |
| 19 | **LoanPurpose** | Categorical | Purpose of loan | 0.1329 | 0.5280 | ⭐⭐ |
| 20 | **OriginalLoanTerm** | Numeric | Original term (months) | 0.1248 | 0.4898 | ⭐ |
| 21 | **NumberOfBorrowers** | Numeric | Number of borrowers | 0.1403 | 0.5559 | ⭐⭐⭐ |
| 22 | **SellerName** | Categorical | Name of seller | 0.1223 | 0.4810 | ⭐ |
| 23 | **ServicerName** | Categorical | Name of servicer | 0.1246 | 0.4981 | ⭐ |
| 24 | **SuperConformingFlag** | Categorical | Super-conforming indicator | 0.1259 | 0.4962 | ⭐ |
| 25 | **PreHARP_Flag** | Categorical | Pre-HARP flag | 0.1261 | 0.5000 | ⭐ |
| 26 | **ProgramIndicator** | Categorical | Program indicator | 0.1289 | 0.5114 | ⭐ |
| 27 | **ReliefRefinanceIndicator** | Categorical | Relief refinance indicator | 0.1261 | 0.5000 | ⭐ |
| 28 | **PropertyValMethod** | Categorical | Property valuation method | 0.1263 | 0.4847 | ⭐ |
| 29 | **InterestOnlyFlag** | Categorical | Interest-only flag | 0.1261 | 0.5000 | ⭐ |
| 30 | **BalloonIndicator** | Categorical | Balloon loan flag | 0.1290 | 0.5124 | ⭐ |

### 1.2 Static Interactions and Behavioral Flags (Index 31–35)

| Idx | Feature | Type | Formula | AUPRC | AUROC | Importance |
|-----|---------|------|---------|-------|-------|------------|
| 31 | **LTV_x_DTI** | Numeric | `OriginalLTV × OriginalDTI` | 0.1368 | 0.5238 | ⭐⭐⭐ |
| 32 | **UPB_per_CreditScore** | Numeric | `OriginalUPB / (CreditScore + 1)` | 0.1296 | 0.5104 | ⭐ |
| 33 | **InterestRate_x_LTV** | Numeric | `OriginalInterestRate × OriginalLTV` | 0.1339 | 0.5256 | ⭐⭐ |
| 34 | **Single_Borrower_Flag** | Indicator | `NumberOfBorrowers == 1` | - | - | ⭐⭐⭐ |
| 35 | **High_DTI_and_Low_CreditScore_Flag** | Indicator | `(OriginalDTI > 43) & (CreditScore < 650)` | - | - | ⭐⭐⭐⭐ |

---

## 2. Debt Servicing Features (Index 36–40)

Generated by `DebtServicingFeatureBuilder` from DTI, LTV, and borrower count.

| Idx | Feature | Type | Description | Formula | AUPRC | AUROC | Importance |
|-----|---------|------|-------------|---------|-------|-------|------------|
| 36 | **DTI_HighRisk_Flag** | Indicator | High DTI flag | `OriginalDTI > 43` | 0.1474 | 0.5712 | ⭐⭐⭐ |
| 37 | **DTI_MidRisk_Flag** | Indicator | Mid DTI flag | `36 < OriginalDTI ≤ 43` | 0.1229 | 0.4840 | ⭐ |
| 38 | **Borrowers_Risk_Flag** | Indicator | Single-borrower risk flag | `NumberOfBorrowers == 1` | - | - | ⭐ |
| 39 | **BorrowerCount_Ajusted_DTI** | Numeric | DTI adjusted by borrower count | `OriginalDTI / √NumberOfBorrowers` | 0.1392 | 0.5312 | ⭐⭐⭐ |
| 40 | **Affordability_Index** | Numeric | Combined stress index | `(OriginalDTI / 43) × (OriginalLTV / 80)` | 0.1368 | 0.5238 | ⭐⭐ |

---

## 3. Leverage Risk Features (Index 41–42)

Generated by `LeverageFeatureBuilder` using estimated LTV sequences.

| Idx | Feature | Type | Description | Formula | AUPRC | AUROC | Importance |
|-----|---------|------|-------------|---------|-------|-------|------------|
| 41 | **LTV_Change** | Numeric | Change in LTV | `EstimatedLTV_last - OriginalLTV` | 0.1308 | 0.5086 | ⭐ |
| 42 | **High_LTV_Flag** | Indicator | Extreme leverage flag | `OriginalLTV ≥ 95` | - | - | ⭐⭐⭐ |

Other leverage measures (volatility, negative equity flags, etc.) were evaluated but removed due to low impact.

---

## 4. Amortization Signals

### 4.1 Primary Signals (Index 43–47)

Produced by `AmortizationFeatureBuilder`. These are the top-performing indicators.

| Idx | Feature | Type | Description | AUPRC | AUROC | Importance |
|-----|---------|------|-------------|-------|-------|------------|
| 43 | **amort_short_mean** | Numeric | Average shortfall ratio (expected vs. observed principal) | **0.3713** | **0.6783** | ⭐⭐⭐⭐⭐ |
| 44 | **amort_short_70** | Numeric | Share of months with shortfall > 70% | **0.3324** | **0.6362** | ⭐⭐⭐⭐⭐ |
| 45 | **amort_short_50** | Numeric | Share of months with shortfall > 50% | **0.3278** | **0.6317** | ⭐⭐⭐⭐⭐ |
| 46 | **amort_short_std** | Numeric | Std. dev. of shortfall ratio | 0.1303 | 0.5541 | ⭐ |
| 47 | **io_payment_count** | Numeric | Count of interest-only months | **0.3198** | **0.6246** | ⭐⭐⭐⭐⭐ |

**Computation Outline**:

1. Expected principal is derived from the annuity payment formula.
2. Observed principal is the month-over-month decline in interest-bearing UPB.
3. Shortfall ratio = `(Expected – Observed) / Expected`, clipped to `[0,1]`.
4. Summary statistics (mean, std, exceedance rates) are computed across months.

Only fixed-rate, non-interest-only, non-balloon loans are included; others receive zero.

### 4.2 Extended Behaviors (Index 48–51)

| Idx | Feature | Type | Description | Formula | Importance |
|-----|---------|------|-------------|---------|------------|
| 48 | **Zero_Payment_Streak** | Numeric | Consecutive months with near-zero principal payments | Latest run of `ObsPrin < 1e-6` | 0.2693 | 0.6029 | ⭐⭐⭐ |
| 49 | **Early_Delinquency_Flag** | Numeric | Count of early payment shortfalls (first six valid months) | `Shortfall > 0.01` threshold count | 0.4999 | 0.8021 | ⭐⭐⭐⭐ |
| 50 | **Amortization_Lag** | Numeric | Periods until first principal payment | `argmax(ObservedPrincipal > 0)` | - | - | ⭐⭐⭐ |
| 51 | **Early_Payment_Trend** | Numeric | Trend of early payments (first six months) | Linear slope of observed principal | - | - | ⭐⭐⭐ |

---

## 5. Maturity Risk (Index 54)

`MaturityRiskFeatureBuilder` produces **MaturityPressure_Index**:

| Idx | Feature | Type | Description | Formula | Importance |
|-----|---------|------|-------------|---------|------------|
| 54 | **MaturityPressure_Index** | Numeric | Remaining UPB pressure at maturity | `CurrentActualUPB_last / (RemainingMonthsToLegalMaturity_last + 1)` | ⭐⭐⭐ |

Higher values indicate heavy principal outstanding relative to time left, signaling maturity pressure.

---

## 6. Composite Feature (Index 52)

| Idx | Feature | Type | Description | Formula | Importance |
|-----|---------|------|-------------|---------|------------|
| 52 | **UPB_trend_x_amort_short_mean** | Numeric | Balance trend × average shortfall | `CurrentActualUPB_w_main_trend × amort_short_mean` | ⭐⭐⭐⭐ |

This cross-builder feature is computed at the pipeline level (`LoanFeaturePipeline.fit/transform`). It captures loans with high balances that are declining slowly while also underpaying principal.

---

## 7. Temporal Features

### 7.1 CurrentNonInterestBearingUPB (Index 53)

| Idx | Feature | Type | Description | AUPRC | AUROC | Importance |
|-----|---------|------|-------------|-------|-------|------------|
| 53 | **CurrentNonInterestBearingUPB_slope_full** | Numeric | Trend of non-interest-bearing UPB (linear slope) | 0.1261 | 0.5000 | ⭐ |

### 7.2 CurrentActualUPB Window Statistics (Index 55–66)

| Idx | Feature | Window | Stat | Notes | AUPRC | AUROC | Importance |
|-----|---------|--------|------|-------|-------|-------|------------|
| 55 | CurrentActualUPB_w_main_trend | (0,3,6,9,12) | Trend | `(last-first)/(|first|+1)` | 0.1395 | 0.5524 | ⭐⭐⭐ |
| 56 | CurrentActualUPB_w_main_vol | (0,3,6,9,12) | Volatility | `std/(|mean|+1)` | 0.1347 | 0.5439 | ⭐⭐⭐ |
| 57 | CurrentActualUPB_w_main_dmean | (0,3,6,9,12) | Diff mean | Mean first difference | 0.1411 | 0.5570 | ⭐⭐⭐ |
| 58 | CurrentActualUPB_w_main_dstd | (0,3,6,9,12) | Diff std | Std of first differences | 0.1218 | 0.4918 | ⭐ |
| 59 | CurrentActualUPB_w_alt1_trend | (0,2,4,6,8,10,12) | Trend | Alternative sampling | 0.1395 | 0.5524 | ⭐⭐⭐ |
| 60 | CurrentActualUPB_w_alt1_vol | Alt1 | Volatility |  | 0.1366 | 0.5491 | ⭐⭐⭐ |
| 61 | CurrentActualUPB_w_alt1_dmean | Alt1 | Diff mean |  | 0.1408 | 0.5565 | ⭐⭐⭐ |
| 62 | CurrentActualUPB_w_alt1_dstd | Alt1 | Diff std |  | 0.1201 | 0.4910 | ⭐ |
| 63 | CurrentActualUPB_w_alt2_trend | (0,3,6,9) | Trend | Compact window | 0.1330 | 0.5374 | ⭐⭐ |
| 64 | CurrentActualUPB_w_alt2_vol | Alt2 | Volatility |  | 0.1284 | 0.5217 | ⭐ |
| 65 | CurrentActualUPB_w_alt2_dmean | Alt2 | Diff mean |  | 0.1311 | 0.5301 | ⭐⭐ |
| 66 | CurrentActualUPB_w_alt2_dstd | Alt2 | Diff std |  | 0.1215 | 0.4918 | ⭐ |

---

## 8. Feature Importance (Single-Feature Isolation Forest)

### Top 15 (by AUPRC)

| Rank | Feature | Index | AUPRC | AUROC | Category |
|------|---------|-------|-------|-------|----------|
| 1 | **amort_short_mean** | 43 | 0.3713 | 0.6783 | Amortization |
| 2 | **amort_short_70** | 44 | 0.3324 | 0.6362 | Amortization |
| 3 | **amort_short_50** | 45 | 0.3278 | 0.6317 | Amortization |
| 4 | **io_payment_count** | 47 | 0.3198 | 0.6246 | Amortization |
| 5 | **CreditScore** | 0 | 0.2106 | 0.6446 | Static |
| 6 | **DTI_HighRisk_Flag** | 36 | 0.1474 | 0.5712 | Debt servicing |
| 7 | **OriginalInterestRate** | 12 | 0.1433 | 0.5453 | Static |
| 8 | **CurrentActualUPB_w_main_dmean** | 57 | 0.1411 | 0.5570 | Temporal |
| 9 | **CurrentActualUPB_w_alt1_dmean** | 61 | 0.1408 | 0.5565 | Temporal |
| 10 | **NumberOfBorrowers** | 21 | 0.1403 | 0.5559 | Static |
| 11 | **CurrentActualUPB_w_alt1_trend** | 59 | 0.1395 | 0.5524 | Temporal |
| 12 | **CurrentActualUPB_w_main_trend** | 55 | 0.1395 | 0.5524 | Temporal |
| 13 | **BorrowerCount_Ajusted_DTI** | 39 | 0.1392 | 0.5312 | Debt servicing |
| 14 | **Affordability_Index** | 40 | 0.1368 | 0.5238 | Debt servicing |
| 15 | **LTV_x_DTI** | 31 | 0.1368 | 0.5238 | Static interaction |

### Flag-Based Detector Performance (Raw Values)

| Detector | Feature | Index | AUPRC | AUROC | Notes |
|----------|---------|-------|-------|-------|-------|
| **#1 Flag Detector** | Early_Delinquency_Flag | 49 | **0.4999** | **0.8021** | Early delinquency signal |
| **#2 Shortfall Detector** | amort_short_mean | 43 | **0.4749** | **0.7525** | Long-run shortfall signal |
| **#3 Streak Detector** | Zero_Payment_Streak | 48 | 0.2693 | 0.6029 | Zero-payment streak |

Fusion of four detectors (Early_Delinquency_Flag, amort_short_mean, Zero_Payment_Streak, LOF(k=50)) achieved **AUPRC = 0.5820**, **AUROC = 0.8203** on validation.

---

## 9. Feature Deletion List

### 9.1 Missing Flags (dropped)
- All `*_missing` indicators.

### 9.2 Noisy Temporal Features (AUPRC ≈ 0.126)
- LoanAge, MonthlyReportingPeriod, CurrentInterestRate, CurrentNonInterestBearingUPB, InterestBearingUPB, RemainingMonthsToLegalMaturity window stats.

### 9.3 Leverage Variants (removed)
- `EstimatedLTV_max`, `EstimatedLTV_std`, `EstimatedLTV_last_val`
- `LTV_Change_Rate`, `LTV_Volatility_Rate`
- `Negative_Equity_Flag`, `Ever_Negative_Equity`, `Negative_Equity_Share`

### 9.4 Other Low-Value Columns
- `amort_mask_not_applicable`
- `Cumulative_Shortfall`
- `Shortfall_Volatility`

---

## 10. Summary Statistics

- **Total features**: 67
- **Static features**: 36 (indices 0–35)
- **Debt-servicing features**: 5 (indices 36–40)
- **Leverage features**: 2 (indices 41–42)
- **Amortization features**: 9 (indices 43–51)
- **Composite feature**: 1 (index 52)
- **Temporal – NIB UPB**: 1 (index 53)
- **Maturity risk**: 1 (index 54)
- **Temporal – CurrentActualUPB**: 12 (indices 55–66)
- **Top single feature**: `amort_short_mean` (AUPRC 0.3713)
- **Best raw detector**: `Early_Delinquency_Flag` (AUPRC 0.4999)
- **Best ensemble**: Fusion model (AUPRC 0.5820, AUROC 0.8203)

**Newly Added Features**

- `Single_Borrower_Flag` (34)
- `High_DTI_and_Low_CreditScore_Flag` (35)
- `High_LTV_Flag` (42)
- `Zero_Payment_Streak` (48)
- `Early_Delinquency_Flag` (49)
- `Amortization_Lag` (50)
- `Early_Payment_Trend` (51)
- `UPB_trend_x_amort_short_mean` (52)
- `MaturityPressure_Index` (54)

---

## 11. Recommendations

### Feature Selection

1. **Must-keep**: All amortization signals (amort_short_mean, amort_short_50, amort_short_70, io_payment_count)
2. **Core detectors**: Early_Delinquency_Flag, amort_short_mean, Zero_Payment_Streak
3. **Strongly recommended**: High_DTI_and_Low_CreditScore_Flag, High_LTV_Flag, Single_Borrower_Flag, MaturityPressure_Index, UPB_trend_x_amort_short_mean
4. **Reinforcement**: Amortization_Lag, Early_Payment_Trend
5. **Static essentials**: CreditScore, NumberOfBorrowers, OriginalInterestRate
6. **Debt-servicing**: DTI_HighRisk_Flag, BorrowerCount_Ajusted_DTI, Affordability_Index
7. **Consider dropping**: Features with AUPRC < 0.13 (near-random)

### Modeling Tips

- Amortization signals dominate performance.
- Combine static + debt-servicing + temporal + amortization for balanced coverage.
- IsolationForest (baseline) works; LOF(k=15, manhattan) performed well.
- Fusion ensemble of detectors yields best validation metrics.

### Fusion Usage

- Combine normalized scores from Early_Delinquency_Flag, amort_short_mean, Zero_Payment_Streak, LOF(k=50) with weights (0.4 / 0.3 / 0.1 / 0.2).
- Run `final_models/run_fusion_ensemble.py` to reproduce validation metrics and generate submissions.

---

## 12. Outputs

Feature generator exports:

- `train_scaled.npy`, `valid_scaled.npy`, `test_scaled.npy`
- `train_labels.npy`, `valid_labels.npy`
- `test_ids.npy`
- `feature_names.txt`

CSV versions are also written to `data/feature_advanced/csv/`.

---

## 13. Revision Log

- Introduced modular builders
- Added debt-servicing, leverage, amortization modules
- Switched to RobustScaler
- Added borrower structure, high DTI + low credit flags
- Added maturity pressure and composite features
- Updated detector performance metrics
- Added fusion ensemble results (AUPRC 0.5820, AUROC 0.8203)

---

## Appendix: Quick Index Reference

- **0–30**: Original static columns
- **31–35**: Interactions and borrower behavior flags
- **36–40**: Debt-servicing features
- **41–42**: Leverage risk features
- **43–47**: Core amortization signals
- **48–51**: Extended amortization behaviors
- **52**: Composite balance × shortfall feature
- **53**: Non-interest-bearing UPB trend
- **54**: Maturity pressure index
- **55–66**: CurrentActualUPB temporal statistics

